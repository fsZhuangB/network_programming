# TCP/IP协议笔记

运输层一个很重要功能：复用和分用

主要协议：

1. UDP
2. TCP

传输时使用ip+port定位计算机中的进程

## TCP协议

TCP数据报格式

  16位：源端口号。 2^16 = 65536 

  16位：目的端口号。

  32序号：也就是4个字节，表示在一个TCP连接中传送的字节流每一个字节都按顺序编号，在TCP建立连接时设置。例如，一个报文段的序号字段值为301，而携带的数据一共有100个字节，这就表明本报文段的数据第一个字节的序号是301，最后一个字节序号为400，而下一个报文段的数据序号应该从401开始。

  32确认序号：占4字节，**指期望收到对方下一个报文段的第一个数据字节的序号。**例如B正确收到了A发送来的一段报文段，序号字段值为501，长度为200字节，这表明B正确收到了A发送的序号700为止的数据，因此B期望收到A的下一个数据序号为701，所以B在发送给A的确认报文段中把确认号置为701 。

>   ​	总结：若确认号为N，那么到N-1为止的所有数据都已经正确收到。

  6个标志位：ACK、URG等

  16位窗口大小。  2^16 = 65536

### 连接建立：三次握手

主动发起连接请求端：发送SYN标志位，请求建立连接，携带确认序号x，和序号，数据字节数，通常为0，以及滑动窗口。

被动接收连接请求端：发送ACK应答标志位，同时携带SYN请求标志位，携带序号，确认序号x，数据字节数，通常为0，以及滑动窗口。

主动发起连接请求端：发送ACK应答标志位，应答服务器连接请求，携带数据确认序号。

### 断开连接：四次挥手

主动关闭连接请求端：发送FIN标志位，请求关闭连接。

被动关闭连接请求端：应答ACK标志位。 ——到此半关闭完成，此时客户端不会写，只会读。（写缓冲被关闭了）

被动关闭连接请求端：发送FIN标志位。

主动关闭连接请求端：应答ACK标志位。——连接全部关闭。

### 滑动窗口

如果发送端发送的速度较快，接收端接收到数据后处理的速度较慢，而接收缓冲区的大小是固定的，就会丢失数据。TCP协议通过“滑动窗口（Sliding Window）”机制解决这一问题。看下图的通讯过程：

![image-20220109152111291](/Users/fszhuangb/Library/Application Support/typora-user-images/image-20220109152111291.png)

9-10的这一段，有可能客户端在等待服务器处理，

### TCP状态转换图

该图很重要，需要掌握。

TIME_WAIT状态只有主动发起关闭的一方会经历。

### 2MSL时长

目的：保证最后一个ACK能被对端接收到，如果对端没有收到，对端还会继续发送FIN请求。

### 端口复用

